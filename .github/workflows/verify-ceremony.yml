name: Verify Ceremony Chain Integrity

on:
  workflow_dispatch: # manual ‚Äúrun verification now‚Äù button
  push:
    branches: ['main']
    paths:
      - 'ceremony/output/**' # outputs only

jobs:
  verify:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js & snarkjs
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install -g snarkjs

      - name: Restore PTAU from cache
        uses: actions/cache@v4
        with:
          path: circuits/ptau/powersOfTau28_hez_final_18.ptau
          key: ptau-${{ runner.os }}-powersOfTau28_hez_final_18-v1

      - name: Secure PTAU provisioning
        shell: bash
        run: |
          set -euo pipefail
          PTAU_PATH="circuits/ptau/powersOfTau28_hez_final_18.ptau"
          mkdir -p "$(dirname "$PTAU_PATH")"
          if [ ! -f "$PTAU_PATH" ]; then
            echo "üîÑ Downloading PTAU file with integrity checks..."
            curl -L --max-time 600 --retry 3 --retry-delay 10 \
              "https://storage.googleapis.com/zkevm/ptau/powersOfTau28_hez_final_18.ptau" \
              -o "$PTAU_PATH"
            if [ ! -s "$PTAU_PATH" ]; then
              echo "‚ùå PTAU file download failed or resulted in empty file"
              rm -f "$PTAU_PATH"
              exit 1
            fi
          else
            echo "‚úÖ PTAU file restored from cache or already present"
          fi
          file_size=$(stat -c%s "$PTAU_PATH" 2>/dev/null || stat -f%z "$PTAU_PATH" 2>/dev/null || echo "unknown")
          ptau_checksum=$(sha256sum "$PTAU_PATH" 2>/dev/null | awk '{print $1}' || echo "unknown")
          echo "üìÅ PTAU size: ${file_size} bytes"
          echo "üîí PTAU checksum: ${ptau_checksum:0:16}..."
          EXPECTED="e970efa7774da80101e0ac336d083ef3339855c98112539338d706b2b89ac694"
          if [ "$ptau_checksum" != "$EXPECTED" ]; then
            echo "‚ùå PTAU checksum mismatch!"
            exit 1
          fi
          if [ "$file_size" != "unknown" ] && [ "$file_size" -lt 1048576 ]; then
            echo "‚ö†Ô∏è PTAU file seems suspiciously small: ${file_size} bytes"
          fi

      - name: Install circom
        shell: bash
        run: |
          set -euo pipefail
          echo "üì¶ Installing circom compiler..."
          curl -L https://github.com/iden3/circom/releases/download/v2.1.9/circom-linux-amd64 \
            -o /usr/local/bin/circom
          chmod +x /usr/local/bin/circom
          circom --version || true
          echo "‚úÖ circom installed"

      - name: Compile circuit for verification
        shell: bash
        run: |
          set -euo pipefail
          echo "üî® Compiling giftcard_merkle circuit..."
          mkdir -p circuits/build
          circom circuits/giftcard_merkle.circom --r1cs --wasm -o circuits/build

          if [ ! -f "circuits/build/giftcard_merkle.r1cs" ]; then
            echo "‚ùå Circuit compilation failed - R1CS not generated"
            exit 1
          fi

          echo "‚úÖ Circuit compiled successfully"

      - name: Run Lambda-ZK Ceremony Chain Verifier
        shell: bash
        run: |
          cd ceremony/scripts
          chmod +x verify_chain.sh
          ./verify_chain.sh

      - name: Upload audit log
        uses: actions/upload-artifact@v4
        with:
          name: ceremony-verification-log-${{ github.run_id }}
          path: ceremony/scripts/chain_verification_*.log
          retention-days: 90

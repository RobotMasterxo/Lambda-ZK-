name: Aggregate Ceremony Contributions

on:
  push:
    branches: ['main']
    paths:
      - 'ceremony/contrib/**/*.zkey'
      - 'ceremony/scripts/run_ceremony.sh'
      - 'circuits/build/giftcard_merkle.r1cs'
      - 'circuits/ptau/**'

  workflow_dispatch:

# Serialize all ceremony workflows to prevent race conditions
# Only one ceremony aggregation can run at a time
# Queued workflows wait for the current one to complete
concurrency:
  group: ceremony-chain-aggregation
  cancel-in-progress: false

jobs:
  aggregate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write
      checks: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install snarkjs with verification
        run: |
          echo "üì¶ Installing snarkjs for ceremony operations..."
          npm install -g snarkjs

          if ! command -v snarkjs >/dev/null 2>&1; then
            echo "‚ùå snarkjs installation failed"
            exit 1
          fi

          snarkjs_version=$(snarkjs --version 2>/dev/null || echo "version_check_failed")
          echo "‚úÖ snarkjs ready: $snarkjs_version"

      - name: Restore PTAU from cache
        uses: actions/cache@v4
        with:
          path: circuits/ptau/powersOfTau28_hez_final_18.ptau
          key: ptau-${{ runner.os }}-powersOfTau28_hez_final_18-v1

      - name: Secure PTAU provisioning
        shell: bash
        run: |
          set -euo pipefail

          PTAU_PATH="circuits/ptau/powersOfTau28_hez_final_18.ptau"
          mkdir -p "$(dirname "$PTAU_PATH")"

          if [ ! -f "$PTAU_PATH" ]; then
            echo "üîÑ Downloading PTAU file with integrity checks..."

            curl -L --max-time 600 --retry 3 --retry-delay 10 \
              "https://storage.googleapis.com/zkevm/ptau/powersOfTau28_hez_final_18.ptau" \
              -o "$PTAU_PATH"

            if [ ! -s "$PTAU_PATH" ]; then
              echo "‚ùå PTAU file download failed or resulted in empty file"
              rm -f "$PTAU_PATH"
              exit 1
            fi
          else
            echo "‚úÖ PTAU file restored from cache or already present"
          fi

          file_size=$(stat -c%s "$PTAU_PATH" 2>/dev/null || stat -f%z "$PTAU_PATH" 2>/dev/null || echo "unknown")
          ptau_checksum=$(sha256sum "$PTAU_PATH" 2>/dev/null | awk '{print $1}' || echo "unknown")

          echo "üìÅ PTAU size: ${file_size} bytes"
          echo "üîí PTAU checksum: ${ptau_checksum:0:16}..."

          EXPECTED="e970efa7774da80101e0ac336d083ef3339855c98112539338d706b2b89ac694"
          if [ "$ptau_checksum" != "$EXPECTED" ]; then
            echo "‚ùå PTAU checksum mismatch!"
            exit 1
          fi

          if [ "$file_size" != "unknown" ] && [ "$file_size" -lt 1048576 ]; then
            echo "‚ö†Ô∏è PTAU file seems suspiciously small: ${file_size} bytes"
          fi

      - name: Install circom
        shell: bash
        run: |
          set -euo pipefail
          curl -L https://github.com/iden3/circom/releases/download/v2.1.9/circom-linux-amd64 \
            -o /usr/local/bin/circom
          chmod +x /usr/local/bin/circom
          circom --version || true

      - name: Compile giftcard_merkle circuit
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p circuits/build
          circom circuits/giftcard_merkle.circom --r1cs --wasm -o circuits/build

      - name: Sync with latest ceremony state (prevent race conditions)
        shell: bash
        run: |
          set -euo pipefail

          echo "üîÑ Syncing with latest ceremony chain state..."

          # Configure git for pulling
          git config user.name "lambda-zk-ceremony[bot]"
          git config user.email "ceremony@lambda-zk.invalid"

          # Pull latest changes from main to get the most recent ceremony state
          # This ensures we know the correct next index even if other workflows completed while we were queued
          echo "üì• Fetching latest ceremony state from origin/main..."
          git fetch origin main

          echo "üîÄ Merging latest ceremony outputs..."
          git merge origin/main --no-edit || {
            echo "‚ö†Ô∏è Merge conflict detected - this should not happen with concurrency group"
            echo "üìã Git status:"
            git status
            exit 1
          }

          echo "‚úÖ Successfully synced with latest ceremony state"

      - name: Check for contributions to process
        shell: bash
        run: |
          set -euo pipefail

          echo "üîç Checking for contributions in contrib directory..."

          CIRCUIT_NAME="giftcard_merkle"
          CONTRIB_DIR="ceremony/contrib"

          # Find all contribution files (both temporary and numbered formats)
          contrib_files=($(find "$CONTRIB_DIR" -maxdepth 1 -type f \( -name "${CIRCUIT_NAME}_tmp_*.zkey" -o -name "${CIRCUIT_NAME}_[0-9]*.zkey" \) 2>/dev/null | sort))

          if [ ${#contrib_files[@]} -eq 0 ]; then
            echo "‚ÑπÔ∏è No new contributions found in contrib directory"
            echo "   Skipping ceremony execution"
            exit 0
          fi

          echo "üì• Found ${#contrib_files[@]} contribution(s) to process:"
          for contrib_file in "${contrib_files[@]}"; do
            echo "   - $(basename "$contrib_file")"
          done

          echo "‚úÖ Contributions ready for processing by run_ceremony.sh"

      - name: Mark pre-ceremony state (detect new vs existing changes)
        id: pre_ceremony_state
        shell: bash
        run: |
          set -euo pipefail

          echo "üì∏ Capturing state before ceremony execution..."

          # Count existing zkeys in output/
          EXISTING_ZKEYS=$(find ceremony/output -name "giftcard_merkle_[0-9][0-9][0-9][0-9].zkey" 2>/dev/null | wc -l)
          echo "EXISTING_ZKEYS=$EXISTING_ZKEYS" >> "$GITHUB_OUTPUT"
          echo "Existing zkeys in output/: $EXISTING_ZKEYS"

      - name: Execute security-enhanced ceremony aggregation
        shell: bash
        run: |
          set -euo pipefail
          cd ceremony/scripts

          echo "üîí Initializing security-enhanced ceremony aggregation..."

          if ./run_ceremony.sh; then
            exit_code=$?
            echo "‚úÖ Ceremony aggregation completed with exit code: $exit_code"

            if [[ $exit_code -eq 0 ]]; then
              echo "‚úÖ Ceremony valid contributions processed - ready for commit"
            elif [[ $exit_code -eq 1 ]]; then
              echo "‚ö†Ô∏è Manual review required - some contributions rejected"
              exit 1
            else
              echo "‚ùå Unexpected ceremony exit code: $exit_code"
              exit $exit_code
            fi

          else
            echo "‚ùå Ceremony execution failed"
            exit 1
          fi

      - name: Security audit before creating PR
        id: commit_status
        shell: bash
        run: |
          set -euo pipefail

          echo "üîí Performing security audit to detect NEW contributions..."

          # Count zkeys AFTER ceremony execution
          CURRENT_ZKEYS=$(find ceremony/output -name "giftcard_merkle_[0-9][0-9][0-9][0-9].zkey" 2>/dev/null | wc -l)
          EXISTING_ZKEYS=${{ steps.pre_ceremony_state.outputs.EXISTING_ZKEYS }}

          # Calculate NEW contributions added by THIS workflow run
          NEW_CONTRIBUTIONS=$((CURRENT_ZKEYS - EXISTING_ZKEYS))

          echo "üìä Zkeys before ceremony: $EXISTING_ZKEYS"
          echo "üìä Zkeys after ceremony: $CURRENT_ZKEYS"
          echo "üìä NEW contributions processed: $NEW_CONTRIBUTIONS"

          if [[ $NEW_CONTRIBUTIONS -gt 0 ]]; then
            # Verify checksum manifest exists
            if [[ ! -f ceremony/output/checksum_manifest.txt ]]; then
              echo "‚ùå Security violation: Missing required checksum manifest"
              exit 1
            fi

            echo "‚úÖ Verified $NEW_CONTRIBUTIONS NEW contributions ready for PR"
            echo "CONTRIBUTION_COUNT=$NEW_CONTRIBUTIONS" >> "$GITHUB_OUTPUT"
            echo "HAS_CHANGES=true" >> "$GITHUB_OUTPUT"
          else
            echo "‚ÑπÔ∏è No NEW contributions processed in this run"
            echo "   This can happen if:"
            echo "   - No files in ceremony/contrib/"
            echo "   - All contributions were already processed in previous commits"
            echo "   - Workflow triggered by non-contribution changes (e.g., script updates)"
            echo "HAS_CHANGES=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Cleanup processed contributions (performance optimization)
        if: steps.commit_status.outputs.HAS_CHANGES == 'true'
        shell: bash
        run: |
          set -euo pipefail

          echo "üßπ Cleaning up processed contributions from contrib directory..."

          # The run_ceremony.sh script already removed processed .zkey files
          # Here we also remove any .processed_* marker files
          CONTRIB_DIR="ceremony/contrib"

          # Count files before cleanup
          BEFORE_COUNT=$(find "$CONTRIB_DIR" -type f -name "*.zkey" 2>/dev/null | wc -l)
          MARKER_COUNT=$(find "$CONTRIB_DIR" -type f -name ".processed_*" 2>/dev/null | wc -l)

          echo "üìä Files in contrib before cleanup: $BEFORE_COUNT .zkey files, $MARKER_COUNT marker files"

          # Remove marker files (they're just for logging)
          find "$CONTRIB_DIR" -type f -name ".processed_*" -delete 2>/dev/null || true

          # Verify cleanup
          AFTER_COUNT=$(find "$CONTRIB_DIR" -type f -name "*.zkey" 2>/dev/null | wc -l)

          if [ "$AFTER_COUNT" -eq 0 ]; then
            echo "‚úÖ Contrib directory is clean - all processed contributions removed"
            echo "   This prevents re-verification on next run (major performance improvement)"
          else
            echo "‚ö†Ô∏è  Warning: $AFTER_COUNT .zkey files remain in contrib/"
            echo "   These may be unprocessed or invalid contributions"
          fi

          # Add cleanup info to git (marker files were created)
          git add "$CONTRIB_DIR/.processed_*" 2>/dev/null || true

      - name: Create aggregation PR
        if: steps.commit_status.outputs.HAS_CHANGES == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "üìù Creating aggregation PR..."

          # Configure git
          git config user.name "lambda-zk-ceremony[bot]"
          git config user.email "ceremony@lambda-zk.invalid"

          # Create new branch for aggregation
          BRANCH_NAME="ceremony-aggregate-${{ github.run_id }}"

          # Delete remote branch if it exists (from previous failed run)
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true

          git checkout -b "$BRANCH_NAME"

          # Stage all changes in ceremony/output/ and ceremony/contrib/
          git add ceremony/output/
          git add ceremony/contrib/  # Include deletions of processed .zkey files

          # Create commit with detailed message
          git commit -m "[CEREMONY] Process ${{ steps.commit_status.outputs.CONTRIBUTION_COUNT }} contribution(s)

          ‚ö° Auto-generated by Lambda-ZK Ceremony 
          üîí Security validation: PASSED
          üìã Checksum manifest: ceremony/output/checksum_manifest.txt
          üîç Audit log: ceremony/scripts/ceremony_*.log

          Changes:
          - ‚úÖ Added new zkeys to ceremony/output/
          - üßπ Removed processed contributions from ceremony/contrib/
          - üìä Updated checksum manifest

          Verification steps completed:
          - ‚úÖ PTAU integrity verified
          - ‚úÖ R1CS validation passed
          - ‚úÖ Cryptographic verification via snarkjs zkey verify
          - ‚úÖ Deterministic ordering maintained
          - ‚úÖ Checksum manifest generated

          Adversarial security: MAINTAINED (‚â•1 honest participant)
          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Push branch (force push in case of workflow retry)
          echo "üöÄ Pushing branch $BRANCH_NAME..."
          git push -u origin "$BRANCH_NAME" --force

          # Create PR with auto-merge
          echo "üìã Creating Pull Request..."
          PR_URL=$(gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "[CEREMONY] Aggregate ${{ steps.commit_status.outputs.CONTRIBUTION_COUNT }} contribution(s)" \
            --body "## üîê Automated Ceremony Aggregation

          This PR was automatically generated by the ceremony aggregation workflow.

          ### Summary
          - **Contributions processed**: ${{ steps.commit_status.outputs.CONTRIBUTION_COUNT }}
          - **Security validation**: ‚úÖ PASSED
          - **Workflow run**: [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### Artifacts Updated
          - ‚úÖ \`ceremony/output/giftcard_merkle_*.zkey\` - New contribution(s)
          - ‚úÖ \`ceremony/output/checksum_manifest.txt\` - Updated checksums
          - ‚úÖ Audit logs uploaded as workflow artifacts

          ### Verification Steps Completed
          1. ‚úÖ PTAU integrity verified
          2. ‚úÖ R1CS validation passed
          3. ‚úÖ Cryptographic verification via \`snarkjs zkey verify\`
          4. ‚úÖ Deterministic ordering maintained
          5. ‚úÖ Checksum manifest generated

          ### Security Properties
          - **Adversarial security**: MAINTAINED (‚â•1 honest participant assumption)
          - **Tamper detection**: SHA-256 checksums for all artifacts
          - **Audit trail**: Complete logs retained for 90 days

          ---
          ü§ñ **This PR will auto-merge when checks pass**")

          echo "PR created: $PR_URL"

          # Extract PR number
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')

          # Enable auto-merge (will merge when checks pass)
          echo "üîÑ Enabling auto-merge for PR #$PR_NUMBER..."

          if gh pr merge "$PR_NUMBER" --auto --squash --delete-branch 2>&1; then
            echo "‚úÖ Auto-merge enabled successfully"
            echo "   PR will merge automatically when all checks pass"
            echo "   Branch will be deleted after merge"
          else
            echo "‚ö†Ô∏è Auto-merge could not be enabled automatically"
            echo "   Please ensure 'Allow auto-merge' is enabled in repository settings"
            echo "   Or merge the PR manually at: $PR_URL"
          fi

          echo "‚úÖ Aggregation PR created successfully"

      - name: Upload ceremony logs on completion
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ceremony-audit-log-${{ github.run_id }}
          path: ceremony/scripts/*.log
          retention-days: 90
